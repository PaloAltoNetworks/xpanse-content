id: AWS - Enrichment
version: -1
name: AWS - Enrichment_patching
description: Given the IP address this playbook enriches EC2 and IAM information.
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 96b01a55-849d-46ad-8ecc-cd1f103f805d
    type: start
    task:
      id: 96b01a55-849d-46ad-8ecc-cd1f103f805d
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "11"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 560,
          "y": -780
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: bf2f9253-209f-48a6-8644-0513be7893f9
    type: title
    task:
      id: bf2f9253-209f-48a6-8644-0513be7893f9
      version: -1
      name: |
        Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -280,
          "y": 2340
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "3":
    id: "3"
    taskid: 2bc235e1-e2b7-41af-8041-fda1d348ff05
    type: regular
    task:
      id: 2bc235e1-e2b7-41af-8041-fda1d348ff05
      version: -1
      name: Lookup SecurityGroup information associated with InstanceID
      description: Describes one or more of your security groups.
      script: AWS - EC2|||aws-ec2-describe-security-groups
      type: regular
      iscommand: true
      brand: AWS - EC2
    nexttasks:
      '#none#':
      - "2"
    scriptarguments:
      groupIds:
        complex:
          root: AWS.EC2.Instances.NetworkInterfaces.Groups
          accessor: GroupId
      region:
        simple: ${AWS.EC2.Instances.Region}
      roleArn:
        simple: ${AssumeRoleArn}
      roleSessionName:
        simple: AWS-Enrichment
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 470,
          "y": 1670
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: d4e0edec-eb3a-49b8-8fa5-aa1fe8b9d354
    type: condition
    task:
      id: d4e0edec-eb3a-49b8-8fa5-aa1fe8b9d354
      version: -1
      name: Was there an EC2 instance?
      description: Check whether the last command returned EC2 information or not.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "2"
      "yes":
      - "3"
      - "23"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: AWS.EC2.Instances
                accessor: InstanceId
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 470,
          "y": 1450
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "11":
    id: "11"
    taskid: 9f88a41a-1d92-4feb-886d-3d67645dc01d
    type: condition
    task:
      id: 9f88a41a-1d92-4feb-886d-3d67645dc01d
      version: -1
      name: Is AWS - EC2 enabled and is Input value defined?
      description: Determines if the AWS - EC2 integration instance is configured and Input values are defined to pull enrichment data.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "2"
      "yes":
      - "12"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.brand
                      iscontext: true
                    right:
                      value:
                        simple: AWS - EC2
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.state
                      iscontext: true
                    right:
                      value:
                        simple: active
            iscontext: true
          right:
            value: {}
      - - operator: isExists
          left:
            value:
              complex:
                root: inputs.AwsIP
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 560,
          "y": -620
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "12":
    continueonerrortype: ""
    id: "12"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "13"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: AWS - EC2
      description: Describes one or more regions that are currently available to you.
      id: 6e0e9b0d-6f6a-493b-8927-6ff21186c26d
      iscommand: true
      name: aws-ec2-describe-regions
      script: AWS - EC2|||aws-ec2-describe-regions
      type: regular
      version: -1
    taskid: 6e0e9b0d-6f6a-493b-8927-6ff21186c26d
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 760,
          "y": -440
        }
      }
  "13":
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              simple: AWS.Regions.RegionName
          operator: isExists
          right:
            value: {}
      label: "yes"
    continueonerrortype: ""
    id: "13"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "16"
      "yes":
      - "14"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Determines if AWS regions were returned from the last command in order to proceed.
      id: 0c70aa0c-d881-4a5b-8a1a-45d8b3792d49
      iscommand: false
      name: Were regions returned?
      type: condition
      version: -1
    taskid: 0c70aa0c-d881-4a5b-8a1a-45d8b3792d49
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 760,
          "y": -280
        }
      }
  "14":
    continueonerrortype: ""
    id: "14"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "15"
    note: false
    quietmode: 0
    scriptarguments:
      AddressRegion:
        simple: ${AWS.Regions.RegionName}
    separatecontext: false
    skipunavailable: false
    task:
      brand: AWS - EC2
      description: Describes IPAM resource discoveries. A resource discovery is an IPAM component that enables IPAM to manage and monitor resources that belong to the owning account.
      id: 1dd458c4-c1c6-4ce8-8e64-9a9ff76184df
      iscommand: true
      name: aws-ec2-describe-ipam-resource-discoveries
      script: AWS - EC2|||aws-ec2-describe-ipam-resource-discoveries
      type: regular
      version: -1
    taskid: 1dd458c4-c1c6-4ce8-8e64-9a9ff76184df
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 760,
          "y": -90
        }
      }
  "15":
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              simple: AWS.EC2.IpamResourceDiscoveries.IpamResourceDiscoveryId
          operator: isExists
          right:
            value: {}
      label: "yes"
    continueonerrortype: ""
    id: "15"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "16"
      "yes":
      - "17"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Determines if AWS IPAM resources discoveries were returned from the last command in order to proceed.
      id: 48226a7c-8dcf-46bd-8707-54268722b5c4
      iscommand: false
      name: Were IPAM resources discoveries returned?
      type: condition
      version: -1
    taskid: 48226a7c-8dcf-46bd-8707-54268722b5c4
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 760,
          "y": 60
        }
      }
  "16":
    continueonerrortype: ""
    id: "16"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "25"
      - "10"
    note: false
    quietmode: 0
    scriptarguments:
      filters:
        complex:
          root: inputs.AwsIP
          transformers:
          - args:
              prefix:
                value:
                  simple: Name=ip-address,Values=
              suffix: {}
            operator: concat
      region:
        simple: ${AWS.Regions.RegionName}
    separatecontext: false
    skipunavailable: false
    task:
      brand: AWS - EC2
      description: Describes one or more of your instances.
      id: 9c91d2e3-991e-4b9b-8e02-29c53436447b
      iscommand: true
      name: Lookup EC2 information associated with IP (default/all regions)
      script: AWS - EC2|||aws-ec2-describe-instances
      type: regular
      version: -1
    taskid: 9c91d2e3-991e-4b9b-8e02-29c53436447b
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 470,
          "y": 980
        }
      }
  "17":
    continueonerrortype: ""
    id: "17"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "18"
    note: false
    quietmode: 0
    scriptarguments:
      AddressRegion:
        simple: ${AWS.EC2.IpamResourceDiscoveries.IpamResourceDiscoveryRegion}
      Filters:
        complex:
          root: inputs.AwsIP
          transformers:
          - args:
              prefix:
                value:
                  simple: Name=address,Values=
              suffix: {}
            operator: concat
      IpamResourceDiscoveryId:
        simple: ${AWS.EC2.IpamResourceDiscoveries.IpamResourceDiscoveryId}
    separatecontext: false
    skipunavailable: false
    task:
      brand: AWS - EC2
      description: Gets the public IP addresses that have been discovered by IPAM.
      id: b082201e-443d-4055-89be-169daadafb6c
      iscommand: true
      name: aws-ec2-get-ipam-discovered-public-addresses
      script: AWS - EC2|||aws-ec2-get-ipam-discovered-public-addresses
      type: regular
      version: -1
    taskid: b082201e-443d-4055-89be-169daadafb6c
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 860,
          "y": 290
        }
      }
  "18":
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              simple: AWS.EC2.IpamDiscoveredPublicAddresses.Address
          operator: isExists
          right:
            value: {}
      label: "yes"
    continueonerrortype: ""
    id: "18"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "16"
      "yes":
      - "20"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Determines if an AWS IPAM public IP was returned from the last command in order to proceed.
      id: 38001173-43c5-4284-8239-00c34c25a906
      iscommand: false
      name: Was there an IPAM discovered public IP returned?
      type: condition
      version: -1
    taskid: 38001173-43c5-4284-8239-00c34c25a906
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 860,
          "y": 450
        }
      }
  "20":
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              complex:
                root: inputs.AWSAssumeRoleName
          operator: isNotEmpty
      label: "yes"
    continueonerrortype: ""
    id: "20"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "21"
      "yes":
      - "22"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Determines if the AWSAssumeRoleName input values are defined in order to proceed.
      id: 9a65bd61-a56a-4490-8789-844e95df7167
      iscommand: false
      name: Is AWSAssumeRoleName input defined?
      type: condition
      version: -1
    taskid: 9a65bd61-a56a-4490-8789-844e95df7167
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 1020,
          "y": 640
        }
      }
  "21":
    continueonerrortype: ""
    id: "21"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "10"
      - "27"
    note: false
    quietmode: 0
    scriptarguments:
      instanceIds:
        simple: ${AWS.EC2.IpamDiscoveredPublicAddresses.InstanceId}
      region:
        simple: ${AWS.EC2.IpamDiscoveredPublicAddresses.AddressRegion}
      roleArn:
        simple: ${AssumeRoleArn}
      roleSessionName:
        simple: AWS-Enrichment
    separatecontext: false
    skipunavailable: false
    task:
      brand: AWS - EC2
      description: Describes one or more of your instances.
      id: 6be69e25-01ab-4600-8d81-01ed7290bd85
      iscommand: true
      name: Lookup EC2 information associated with IP (IPAM info)
      script: AWS - EC2|||aws-ec2-describe-instances
      type: regular
      version: -1
    taskid: 6be69e25-01ab-4600-8d81-01ed7290bd85
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 890,
          "y": 980
        }
      }
  "22":
    continueonerrortype: ""
    id: "22"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "21"
    note: false
    quietmode: 0
    scriptarguments:
      key:
        simple: AssumeRoleArn
      value:
        complex:
          accessor: AddressOwnerId
          root: AWS.EC2.IpamDiscoveredPublicAddresses
          transformers:
          - args:
              prefix:
                value:
                  simple: 'arn:aws:iam::'
              suffix:
                value:
                  simple: :role/
            operator: concat
          - args:
              prefix: {}
              suffix:
                iscontext: true
                value:
                  simple: inputs.AWSAssumeRoleName
            operator: concat
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Set a value in context under the key you entered.
      id: 3a0cc28e-3a28-4f1a-8de9-37cbd44e6f2e
      iscommand: false
      name: Set roleArn in temporary context
      script: Set
      type: regular
      version: -1
    taskid: 3a0cc28e-3a28-4f1a-8de9-37cbd44e6f2e
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 760,
          "y": 810
        }
      }
  "23":
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              complex:
                filters:
                - - left:
                      iscontext: true
                      value:
                        simple: modules.brand
                    operator: isEqualString
                    right:
                      value:
                        simple: AWS - Organizations
                - - left:
                      iscontext: true
                      value:
                        simple: modules.state
                    operator: isEqualString
                    right:
                      value:
                        simple: active
                root: modules
          operator: isExists
          right:
            value: {}
      label: "yes"
    continueonerrortype: ""
    id: "23"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "2"
      "yes":
      - "24"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Determines if the AWS - Organizations integration instance is configured to pull hierarchy info.
      id: 59a3987c-8f23-4af8-8a39-397608d24efb
      iscommand: false
      name: Is AWS - Organizations enabled ?
      type: condition
      version: -1
    taskid: 59a3987c-8f23-4af8-8a39-397608d24efb
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 890,
          "y": 1670
        }
      }
  "24":
    continueonerrortype: ""
    id: "24"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "2"
    note: false
    quietmode: 0
    scriptarguments:
      account_id:
        complex:
          accessor: OwnerId
          root: AWS.EC2.Instances.NetworkInterfaces
          transformers:
          - operator: uniq
    separatecontext: false
    skipunavailable: true
    task:
      brand: ""
      description: Determine AWS account hierarchy by looking up parent objects until the organization level is reached.
      id: 0790f810-5a9a-41f8-8f66-51ab82e4bbd2
      iscommand: false
      name: AWSAccountHierarchy
      script: AWSAccountHierarchy
      type: regular
      version: -1
    taskid: 0790f810-5a9a-41f8-8f66-51ab82e4bbd2
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 880,
          "y": 1890
        }
      }
  "25":
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              complex:
                filters:
                - - left:
                      iscontext: true
                      value:
                        simple: modules.brand
                    operator: isEqualString
                    right:
                      value:
                        simple: AWS - System Manager
                - - left:
                      iscontext: true
                      value:
                        simple: modules.state
                    operator: isEqualString
                    right:
                      value:
                        simple: active
                root: modules
          operator: isExists
          right:
            value: {}
      label: "yes"
    continueonerrortype: ""
    id: "25"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "2"
      "yes":
      - "26"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Determines if the AWS - Systems Manager integration instance is configured.
      id: 3f9e9968-cae2-4f4e-86cf-e1d15e52fece
      iscommand: false
      name: Is AWS - Systems Manager enabled?
      type: condition
      version: -1
    taskid: 3f9e9968-cae2-4f4e-86cf-e1d15e52fece
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 50,
          "y": 1185
        }
      }
  "26":
    continueonerrortype: ""
    id: "26"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "2"
    note: false
    quietmode: 0
    scriptarguments:
      instance_id:
        simple: ${AWS.EC2.Instances.InstanceId}
      region:
        simple: ${AWS.Regions.RegionName}
      type_name:
        simple: Instance Information
    separatecontext: false
    skipunavailable: false
    task:
      brand: AWS - System Manager
      description: A list of inventory items returned by the request.
      id: 74f8d800-1e59-4140-839d-b40524e401c0
      iscommand: true
      name: Get Instance ID information from SSM Inventory list.
      script: AWS - System Manager|||aws-ssm-inventory-entry-list
      type: regular
      version: -1
    taskid: 74f8d800-1e59-4140-839d-b40524e401c0
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 50,
          "y": 1450
        }
      }
  "27":
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              complex:
                filters:
                - - left:
                      iscontext: true
                      value:
                        simple: modules.brand
                    operator: isEqualString
                    right:
                      value:
                        simple: AWS - System Manager
                - - left:
                      iscontext: true
                      value:
                        simple: modules.state
                    operator: isEqualString
                    right:
                      value:
                        simple: active
                root: modules
          operator: isExists
          right:
            value: {}
      label: "yes"
    continueonerrortype: ""
    id: "27"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "2"
      "yes":
      - "28"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Determines if the AWS - Systems Manager integration instance is configured.
      id: c233cee8-b8aa-4510-8740-d66f41467778
      iscommand: false
      name: Is AWS - Systems Manager enabled?
      type: condition
      version: -1
    taskid: c233cee8-b8aa-4510-8740-d66f41467778
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 1390,
          "y": 1185
        }
      }
  "28":
    continueonerrortype: ""
    id: "28"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "2"
    note: false
    quietmode: 0
    scriptarguments:
      instance_id:
        simple: ${AWS.EC2.IpamDiscoveredPublicAddresses.InstanceId}
      region:
        simple: ${AWS.EC2.IpamDiscoveredPublicAddresses.AddressRegion}
      roleArn:
        simple: ${AssumeRoleArn}
      roleSessionName:
        simple: AWS-SSM-Command
      type_name:
        simple: Instance Information
    separatecontext: false
    skipunavailable: false
    task:
      brand: AWS - System Manager
      description: A list of inventory items returned by the request.
      id: c0ad2d69-2660-4d03-8d01-fb61577cb103
      iscommand: true
      name: Get Instance ID information from SSM Inventory list.
      script: AWS - System Manager|||aws-ssm-inventory-entry-list
      type: regular
      version: -1
    taskid: c0ad2d69-2660-4d03-8d01-fb61577cb103
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 1400,
          "y": 1450
        }
      }
view: |-
  {
    "linkLabelsPosition": {
      "10_2_#default#": 0.42,
      "10_3_yes": 0.55,
      "13_16_#default#": 0.35,
      "15_16_#default#": 0.22,
      "18_16_#default#": 0.35,
      "20_21_#default#": 0.31,
      "23_2_#default#": 0.33
    },
    "paper": {
      "dimensions": {
        "height": 3185,
        "width": 2060,
        "x": -280,
        "y": -780
      }
    }
  }
inputs:
- key: "AwsIP"
  value:
    complex:
      accessor: remoteip
      root: alert
  required: true
  description: "AWS IP in alert"
  playbookInputQuery:
- key: AWSAssumeRoleName
  value: {}
  required: false
  description: If assuming roles for AWS, this is the name of the role to assume (should be the same for all organizations).
  playbookInputQuery:
- description: ""
  key: ""
  playbookInputQuery:
    daterange:
      fromdate: "0001-01-01T00:00:00Z"
      fromdatelicenseval: "0001-01-01T00:00:00Z"
      period:
        by: ""
        byfrom: ""
        byto: ""
        field: ""
        fromvalue:
        tovalue:
      todate: "0001-01-01T00:00:00Z"
    query: ""
    queryEntity: indicators
    results:
    runFromLastJobTime: true
  required: false
  value: {}
outputs:
- contextPath: AWS.EC2.Instances
  description: AWS EC2 information.
  type: unknown
- contextPath: AWS.EC2.SecurityGroups
  description: AWS Security group information.
  type: unknown
- contextPath: AWSHierarchy
  description: AWS account hierarchy information.
  type: unknown
- contextPath: AWS.SSM.InventoryEntry
  description: AWS SSM information of an Instance ID.
  type: unknown
quiet: true
fromversion: 6.5.0
tests:
- No tests (auto formatted)
inputSections:
- description: Generic group for inputs
  inputs:
  - AwsIP
  - AWSAssumeRoleName
  name: General (Inputs group)
outputSections:
- description: Generic group for outputs
  name: General (Outputs group)
  outputs:
  - AWS.EC2.Instances
  - AWS.EC2.SecurityGroups
  - AWSHierarchy
  - AWS.SSM.InventoryEntry
