id: GCP - Firewall Remediation
version: -1
name: GCP - Firewall Remediation
description: This playbook adds new firewall rules with access only from  private ip address range and blocks traffic that's exposed to public internet. For example, if RDP is exposed to the entire world, this playbook adds new firewall rules that only allows traffic from private ip address and blocks rest of the RDP traffic.
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: e7f04be3-9925-4568-88d2-0f5a83040fcf
    type: start
    task:
      id: e7f04be3-9925-4568-88d2-0f5a83040fcf
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "1"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 500,
          "y": -130
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: 35c1ac08-f01e-437f-8605-c284d24aff40
    type: condition
    task:
      id: 35c1ac08-f01e-437f-8605-c284d24aff40
      version: -1
      name: Is Google Cloud Compute enabled and are Input values defined?
      description: Determines if the AWS - EC2 integration instance is configured and Input values are defined to pull enrichment data.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "33"
      "yes":
      - "37"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.brand
                      iscontext: true
                    right:
                      value:
                        simple: Google Cloud Compute
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.state
                      iscontext: true
                    right:
                      value:
                        simple: active
            iscontext: true
          right:
            value: {}
      - - operator: isExists
          left:
            value:
              complex:
                root: inputs.GcpInstance
            iscontext: true
      - - operator: isExists
          left:
            value:
              complex:
                root: inputs.GcpZone
            iscontext: true
      - - operator: isExists
          left:
            value:
              complex:
                root: inputs.GcpNetwork
            iscontext: true
      - - operator: isExists
          left:
            value:
              complex:
                root: inputs.RemotePort
            iscontext: true
      - - operator: isExists
          left:
            value:
              complex:
                root: inputs.RemoteProtocol
            iscontext: true
      - - operator: isExists
          left:
            value:
              complex:
                root: inputs.GcpProject
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 500,
          "y": 0
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: d85cd175-1f8e-4993-8dee-723248d0648d
    type: title
    task:
      id: d85cd175-1f8e-4993-8dee-723248d0648d
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 440,
          "y": 2340
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "16":
    id: "16"
    taskid: 3d0d2868-a83a-4a99-8f9f-b72b6449b7e3
    type: condition
    task:
      id: 3d0d2868-a83a-4a99-8f9f-b72b6449b7e3
      version: -1
      name: Does the remediation allow rule exist?
      description: Check whether the last command returned remediation allow rule or not.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "25"
      "yes":
      - "18"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: GoogleCloudCompute.Firewalls.name
                filters:
                - - operator: containsGeneral
                    left:
                      value:
                        simple: GoogleCloudCompute.Firewalls.name
                      iscontext: true
                    right:
                      value:
                        simple: allow
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 320,
          "y": 1280
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: c2dceda0-28b9-4c30-81e8-66e0fad21c34
    type: regular
    task:
      id: c2dceda0-28b9-4c30-81e8-66e0fad21c34
      version: -1
      name: Get network tags information.
      description: Returns the tags of instance.
      script: Google Cloud Compute|||gcp-compute-get-instance
      type: regular
      iscommand: true
      brand: Google Cloud Compute
    nexttasks:
      '#none#':
      - "27"
    scriptarguments:
      instance:
        complex:
          root: inputs.GcpInstance
          transformers:
          - operator: uniq
      zone:
        complex:
          root: inputs.GcpZone
          transformers:
          - operator: uniq
      project_id:
        complex:
          root: inputs.GcpProject
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 540,
          "y": 1770
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "24":
    id: "24"
    taskid: 93a9e098-459a-40b1-88c2-73661f69d459
    type: regular
    task:
      id: 93a9e098-459a-40b1-88c2-73661f69d459
      version: -1
      name: Add block everything firewall rule
      description: Creates a firewall rule in the specified project using the data included in the request.
      script: Google Cloud Compute|||gcp-compute-insert-firewall
      type: regular
      iscommand: true
      brand: Google Cloud Compute
    nexttasks:
      '#none#':
      - "18"
    scriptarguments:
      denied:
        complex:
          root: inputs.RemotePort
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: ',ports='
              suffix: {}
          - operator: concat
            args:
              prefix:
                value:
                  simple: inputs.RemoteProtocol
                iscontext: true
              suffix: {}
          - operator: concat
            args:
              prefix:
                value:
                  simple: ipprotocol=
              suffix: {}
          - operator: toLowerCase
          - operator: uniq
      direction:
        simple: INGRESS
      name:
        complex:
          root: RuleSuffix
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: remediation-block-
              suffix: {}
      network:
        complex:
          root: inputs.GcpNetwork
          transformers:
          - operator: uniq
      priority:
        simple: "1"
      sourceRanges:
        simple: 0.0.0.0/0
      targetTags:
        complex:
          root: inputs.RemotePort
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: remediation-tag-
              suffix: {}
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: '-'
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.RemoteProtocol
                iscontext: true
          - operator: toLowerCase
          - operator: uniq
      project_id:
        complex:
          root: inputs.GcpProject
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 810,
          "y": 1580
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "25":
    id: "25"
    taskid: 6629ca82-de72-4b88-8795-4253ed4e09b5
    type: regular
    task:
      id: 6629ca82-de72-4b88-8795-4253ed4e09b5
      version: -1
      name: Add allow rule
      description: Creates a firewall rule in the specified project using the data included in the request.
      script: Google Cloud Compute|||gcp-compute-insert-firewall
      type: regular
      iscommand: true
      brand: Google Cloud Compute
    nexttasks:
      '#none#':
      - "18"
    scriptarguments:
      allowed:
        complex:
          root: inputs.RemotePort
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: ',ports='
              suffix: {}
          - operator: concat
            args:
              prefix:
                value:
                  simple: inputs.RemoteProtocol
                iscontext: true
              suffix: {}
          - operator: concat
            args:
              prefix:
                value:
                  simple: ipprotocol=
              suffix: {}
          - operator: uniq
      direction:
        simple: INGRESS
      name:
        complex:
          root: RuleSuffix
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: remediation-allow-
              suffix: {}
      network:
        complex:
          root: inputs.GcpNetwork
          transformers:
          - operator: uniq
      priority:
        simple: "0"
      sourceRanges:
        simple: 172.16.0.0/12,10.0.0.0/8,192.168.0.0/16
      targetTags:
        complex:
          root: inputs.RemotePort
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: remediation-tag-
              suffix: {}
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: '-'
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.RemoteProtocol
                iscontext: true
          - operator: toLowerCase
          - operator: uniq
      project_id:
        complex:
          root: inputs.GcpProject
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 280,
          "y": 1580
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "27":
    id: "27"
    taskid: 1a746900-ba67-40c2-827b-55ff558115ed
    type: condition
    task:
      id: 1a746900-ba67-40c2-827b-55ff558115ed
      version: -1
      name: Does the network tags already exist on the instance?
      description: |+
        Check whether the last command returned remediation tag or not. If the tag is not present, the tag remediation-tag-{port#}-{protocol} is created.

      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "30"
      "yes":
      - "2"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: GoogleCloudCompute.Instances.tags
                accessor: items
            iscontext: true
          right:
            value:
              complex:
                root: inputs.RemotePort
                transformers:
                - operator: concat
                  args:
                    prefix:
                      value:
                        simple: remediation-tag-
                    suffix: {}
                - operator: concat
                  args:
                    prefix: {}
                    suffix:
                      value:
                        simple: '-'
                - operator: concat
                  args:
                    prefix: {}
                    suffix:
                      value:
                        simple: inputs.RemoteProtocol
                      iscontext: true
                - operator: toLowerCase
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 540,
          "y": 1940
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "30":
    id: "30"
    taskid: aeb304d4-17fc-437c-8a80-91079bf85bb1
    type: regular
    task:
      id: aeb304d4-17fc-437c-8a80-91079bf85bb1
      version: -1
      name: Add and set network tags
      description: Add network tag for the specified instance.
      script: Google Cloud Compute|||gcp-compute-add-network-tag
      type: regular
      iscommand: true
      brand: Google Cloud Compute
    nexttasks:
      '#none#':
      - "2"
    scriptarguments:
      instance:
        complex:
          root: inputs.GcpInstance
      tag:
        complex:
          root: inputs.RemotePort
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: remediation-tag-
              suffix: {}
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: '-'
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.RemoteProtocol
                iscontext: true
          - operator: toLowerCase
      zone:
        complex:
          root: inputs.GcpZone
      project_id:
        complex:
          root: inputs.GcpProject
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 740,
          "y": 2150
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "32":
    id: "32"
    taskid: c5fd3ee9-0b61-48ac-867c-bf6d38017e18
    type: regular
    task:
      id: c5fd3ee9-0b61-48ac-867c-bf6d38017e18
      version: -1
      name: Lookup firewall remediation allow rule
      description: Retrieves the list of firewall rules available to the specified project. If these don't exist, the allow and block rules are created of the format remediation-[allow|block]-port-{port#}-{protocol}.
      script: Google Cloud Compute|||gcp-compute-list-firewall
      type: regular
      iscommand: true
      brand: Google Cloud Compute
    nexttasks:
      '#none#':
      - "16"
    scriptarguments:
      filters:
        complex:
          root: RuleSuffix
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: name="remediation-allow-
              suffix:
                value:
                  simple: '"'
      project_id:
        complex:
          root: inputs.GcpProject
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 320,
          "y": 1100
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "33":
    id: "33"
    taskid: 9d5e997a-d984-4dfc-8b4b-83f0cb14cb47
    type: title
    task:
      id: 9d5e997a-d984-4dfc-8b4b-83f0cb14cb47
      version: -1
      name: continue
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "2"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 20,
          "y": 200
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "34":
    id: "34"
    taskid: 9228e88b-d8ad-4a81-87db-974ca7ae2a32
    type: regular
    task:
      id: 9228e88b-d8ad-4a81-87db-974ca7ae2a32
      version: -1
      name: Lookup firewall remediation block rule
      description: Retrieves the list of firewall rules available to the specified project. If these don't exist, the allow and block rules are created of the format remediation-[allow|block]-port-{port#}-{protocol}.
      script: Google Cloud Compute|||gcp-compute-list-firewall
      type: regular
      iscommand: true
      brand: Google Cloud Compute
    nexttasks:
      '#none#':
      - "35"
    scriptarguments:
      filters:
        complex:
          root: RuleSuffix
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: name="remediation-block-
              suffix:
                value:
                  simple: '"'
      project_id:
        complex:
          root: inputs.GcpProject
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 740,
          "y": 1100
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "35":
    id: "35"
    taskid: 198b8f9f-2e80-428b-8304-49ece70c4184
    type: condition
    task:
      id: 198b8f9f-2e80-428b-8304-49ece70c4184
      version: -1
      name: Does the remediation block rule exist?
      description: Check whether the last command returned remediation block rule or not.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "24"
      "yes":
      - "18"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: GoogleCloudCompute.Firewalls.name
                filters:
                - - operator: containsGeneral
                    left:
                      value:
                        simple: GoogleCloudCompute.Firewalls.name
                      iscontext: true
                    right:
                      value:
                        simple: block
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 740,
          "y": 1280
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "37":
    id: "37"
    taskid: 6ee1dedc-e09e-4a58-8f7f-dead6c06edff
    type: title
    task:
      id: 6ee1dedc-e09e-4a58-8f7f-dead6c06edff
      version: -1
      name: Check if network name is too long
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "38"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 510,
          "y": 200
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "38":
    id: "38"
    taskid: c1e67727-ab17-48d8-88c4-173519b80cf6
    type: regular
    task:
      id: c1e67727-ab17-48d8-88c4-173519b80cf6
      version: -1
      name: Set VPCNetwork temporary context
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "39"
    scriptarguments:
      key:
        simple: VPCNetwork
      value:
        complex:
          root: inputs.GcpNetwork
          transformers:
          - operator: split
            args:
              delimiter:
                value:
                  simple: networks/
          - operator: LastArrayElement
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 510,
          "y": 330
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "39":
    id: "39"
    taskid: 4e1d843f-79ba-45c6-8506-f383c844da8e
    type: condition
    task:
      id: 4e1d843f-79ba-45c6-8506-f383c844da8e
      version: -1
      name: Is VPC network name short enough?
      description: Check whether the VPC name is more than 30 characters, because if it is that means the rule firewall rule name will be too long.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "43"
      "yes":
      - "40"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: lessThanOrEqual
          left:
            value:
              complex:
                root: VPCNetwork
                transformers:
                - operator: strLength
            iscontext: true
          right:
            value:
              simple: "30"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 510,
          "y": 500
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "40":
    id: "40"
    taskid: 5324ca5b-ea62-41f7-86ad-d94f09df30b7
    type: regular
    task:
      id: 5324ca5b-ea62-41f7-86ad-d94f09df30b7
      version: -1
      name: Set RuleSuffix temporary context
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "32"
      - "34"
    scriptarguments:
      key:
        simple: RuleSuffix
      value:
        complex:
          root: inputs.RemotePort
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: -port-
              suffix:
                value:
                  simple: '-'
          - operator: concat
            args:
              prefix:
                value:
                  simple: VPCNetwork
                iscontext: true
              suffix:
                value:
                  simple: inputs.RemoteProtocol
                iscontext: true
          - operator: toLowerCase
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 510,
          "y": 860
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "43":
    id: "43"
    taskid: 60012ee4-4dbd-457f-8725-3f2001f2c114
    type: regular
    task:
      id: 60012ee4-4dbd-457f-8725-3f2001f2c114
      version: -1
      name: Set VPCNetwork temporary context (truncated)
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "40"
    scriptarguments:
      append:
        simple: "false"
      key:
        simple: VPCNetwork
      value:
        complex:
          root: VPCNetwork
          transformers:
          - operator: substring
            args:
              from:
                value:
                  simple: "0"
              to:
                value:
                  simple: "29"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 760,
          "y": 690
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "16_18_yes": 0.32,
      "35_18_yes": 0.36,
      "39_40_yes": 0.49
    },
    "paper": {
      "dimensions": {
        "height": 2535,
        "width": 1170,
        "x": 20,
        "y": -130
      }
    }
  }
inputs:
- key: GcpInstance
  value: {}
  required: true
  description: The name of the GCP instance that has the public ip.
  playbookInputQuery:
- key: GcpZone
  value: {}
  required: true
  description: The zone of the GCP instance that is hosted in.
  playbookInputQuery:
- key: GcpNetwork
  value: {}
  required: true
  description: The VPC network of the GCP instance.
  playbookInputQuery:
- key: RemotePort
  value:
    complex:
      root: alert
      accessor: remoteport
  required: true
  description: The remote port that is publicly exposed to.
  playbookInputQuery:
- key: RemoteProtocol
  value: {}
  required: true
  description: The remote protocol that is publicly exposed to.
  playbookInputQuery:
- key: GcpProject
  value:
    complex:
      root: alert.asmcloud
      accessor: Project
      transformers:
      - operator: FirstArrayElement
  required: true
  description: The name of the GCP project associated with the instance and related objects.
  playbookInputQuery:
outputs: []
tests:
- No tests (auto formatted)
fromversion: 6.5.0
