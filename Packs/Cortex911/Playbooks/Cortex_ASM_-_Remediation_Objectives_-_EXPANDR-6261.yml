id: Cortex ASM - Remediation Objectives - EXPANDR-6261
version: 10
vcShouldKeepItemLegacyProdMachine: false
name: Cortex ASM - Remediation Objectives - EXPANDR-6261
description: Playbook that populates the remediation objectives field that is used to display the remediation actions to the end user.
starttaskid: '0'
tasks:
  '0':
    id: '0'
    taskid: 49c2153d-aec5-41e9-8ba1-4a1a14fa5d74
    type: start
    task:
      id: 49c2153d-aec5-41e9-8ba1-4a1a14fa5d74
      version: -1
      name: ''
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '14'
    separatecontext: false
    continueonerrortype: ''
    view: "{\n  \"position\": {\n    \"x\": 550,\n    \"y\": -180\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '4':
    id: '4'
    taskid: 958f1522-7649-4ffe-88ee-712809a4336a
    type: regular
    task:
      id: 958f1522-7649-4ffe-88ee-712809a4336a
      version: -1
      name: Set remediation objectives grid field
      description: "Automation used to more easily populate a grid field.  This is necessary when you want to assign certain values as static or if you have context paths that you will assign to different values as well.  Instead of a value you can enter `TIMESTAMP` to get the current timestamp in ISO format. For example:\n`!GridFieldSetup keys=ip,src,timestamp val1=${AWS.EC2.Instances.NetworkInterfaces.PrivateIpAddress} val2=\"AWS\" val3=\"TIMESTAMP\" gridfiled=\"gridfield\"`"
      scriptName: GridFieldSetup
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '5'
    scriptarguments:
      gridfield:
        simple: asmremediationobjectives
      keys:
        simple: option,statement
      val1:
        simple: Automated remediation by blocking open ports
      val2:
        simple: "In this case, automated remediation will replace the security group that is allowing the risky service to be exposed to the public internet with a new security group: the new security group be created with the name of the old security group with '_xpanse_ar_XXX' appended to it and XXX signifies a random three digit number so there are no naming conflicts."
    separatecontext: false
    continueonerrortype: ''
    view: "{\n  \"position\": {\n    \"x\": 750,\n    \"y\": 500\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '5':
    id: '5'
    taskid: f329502a-fe69-4c67-8c9b-fe744ff6c709
    type: title
    task:
      id: f329502a-fe69-4c67-8c9b-fe744ff6c709
      version: -1
      name: Complete
      type: title
      iscommand: false
      brand: ''
    separatecontext: false
    continueonerrortype: ''
    view: "{\n  \"position\": {\n    \"x\": 550,\n    \"y\": 830\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '9':
    id: '9'
    taskid: 237ae915-4b09-4d20-8ba8-b30b8e01c4fe
    type: regular
    task:
      id: 237ae915-4b09-4d20-8ba8-b30b8e01c4fe
      version: -1
      name: Set remediation objectives grid field
      description: "Automation used to more easily populate a grid field.  This is necessary when you want to assign certain values as static or if you have context paths that you will assign to different values as well.  Instead of a value you can enter `TIMESTAMP` to get the current timestamp in ISO format. For example:\n`!GridFieldSetup keys=ip,src,timestamp val1=${AWS.EC2.Instances.NetworkInterfaces.PrivateIpAddress} val2=\"AWS\" val3=\"TIMESTAMP\" gridfiled=\"gridfield\"`"
      scriptName: GridFieldSetup
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '5'
    scriptarguments:
      gridfield:
        simple: asmremediationobjectives
      keys:
        simple: option,statement
      val1:
        simple: Automated remediation by blocking open ports
      val2:
        complex:
          root: PortAndProtocol
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: 'In this case, automated remediation will add new Azure Network Security Groups (NSG) rules to NSG attached to a NIC: rule remediation-block-port-'
              suffix:
                value:
                  simple: ' will block all internet traffic to this service and remediation-allow-port-'
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: PortAndProtocol
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ' will ensure that internal communication to this asset can continue.'
    separatecontext: false
    continueonerrortype: ''
    view: "{\n  \"position\": {\n    \"x\": -50,\n    \"y\": 500\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '10':
    id: '10'
    taskid: 1fdc6406-9503-4ad3-88d6-69b3e7e05cb4
    type: regular
    task:
      id: 1fdc6406-9503-4ad3-88d6-69b3e7e05cb4
      version: -1
      name: Set remediation objectives grid field
      description: "Automation used to more easily populate a grid field.  This is necessary when you want to assign certain values as static or if you have context paths that you will assign to different values as well.  Instead of a value you can enter `TIMESTAMP` to get the current timestamp in ISO format. For example:\n`!GridFieldSetup keys=ip,src,timestamp val1=${AWS.EC2.Instances.NetworkInterfaces.PrivateIpAddress} val2=\"AWS\" val3=\"TIMESTAMP\" gridfiled=\"gridfield\"`"
      scriptName: GridFieldSetup
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '5'
    scriptarguments:
      gridfield:
        simple: asmremediationobjectives
      keys:
        simple: option,statement
      val1:
        simple: Automated remediation by creating empty S3 bucket
      val2:
        complex:
          root: bucketname
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: 'In this case, automated remediation will create an empty S3 bucket with no external access that matches the organizationâ€™s undefined DNS CNAME record: the DNS name '
              suffix:
                value:
                  simple: ' was queried and the Bucket name '
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: bucketname
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ' will be created.'
    separatecontext: false
    continueonerrortype: ''
    view: "{\n  \"position\": {\n    \"x\": 1150,\n    \"y\": 500\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '12':
    id: '12'
    taskid: d2b3a898-b90b-4700-8756-18314e35520a
    type: regular
    task:
      id: d2b3a898-b90b-4700-8756-18314e35520a
      version: -1
      name: Set remediation objectives grid field
      description: "Automation used to more easily populate a grid field.  This is necessary when you want to assign certain values as static or if you have context paths that you will assign to different values as well.  Instead of a value you can enter `TIMESTAMP` to get the current timestamp in ISO format. For example:\n`!GridFieldSetup keys=ip,src,timestamp val1=${AWS.EC2.Instances.NetworkInterfaces.PrivateIpAddress} val2=\"AWS\" val3=\"TIMESTAMP\" gridfiled=\"gridfield\"`"
      scriptName: GridFieldSetup
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '5'
    scriptarguments:
      gridfield:
        simple: asmremediationobjectives
      keys:
        simple: option,statement
      val1:
        simple: Automated remediation by blocking open ports
      val2:
        complex:
          root: alert.asmsystemids
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: alert.asmsystemids.type
                iscontext: true
              right:
                value:
                  simple: ASSET-NAME
          accessor: id
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: ' will ensure that internal communication to this asset can continue.  After these rules are created, '
              suffix:
                value:
                  simple: ' will have a new network tag named remediation-tag-'
          - operator: concat
            args:
              prefix:
                value:
                  simple: PortAndProtocol
                iscontext: true
              suffix:
                value:
                  simple: PortAndProtocol
                iscontext: true
          - operator: concat
            args:
              prefix:
                value:
                  simple: -port-
              suffix: {}
          - operator: concat
            args:
              prefix:
                value:
                  simple: VPCNetwork
                iscontext: true
              suffix: {}
          - operator: concat
            args:
              prefix:
                value:
                  simple: ' will block all internet traffic to this service and remediation-allow-'
              suffix:
                value:
                  simple: ' which will apply these new firewall rules and restrict public internet access.'
          - operator: concat
            args:
              prefix:
                value:
                  simple: PortAndProtocol
                iscontext: true
              suffix: {}
          - operator: concat
            args:
              prefix:
                value:
                  simple: -port-
              suffix: {}
          - operator: concat
            args:
              prefix:
                value:
                  simple: VPCNetwork
                iscontext: true
              suffix: {}
          - operator: concat
            args:
              prefix:
                value:
                  simple: 'In this case, automated remediation will create two new firewall rules: rule remediation-block-'
              suffix: {}
    separatecontext: false
    continueonerrortype: ''
    view: "{\n  \"position\": {\n    \"x\": 350,\n    \"y\": 500\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '14':
    id: '14'
    taskid: ae3adf58-e23e-411c-8faa-4437e3ad3bd9
    type: condition
    task:
      id: ae3adf58-e23e-411c-8faa-4437e3ad3bd9
      version: -1
      name: What provider is this service?
      description: Determines which cloud provider the service is in order to direct to the correct enrichment.
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      AWS:
      - '4'
      Azure:
      - '21'
      GCP:
      - '20'
      On Prem:
      - '28'
      Unclaimed S3 Bucket:
      - '17'
    separatecontext: false
    conditions:
    - label: AWS
      condition:
      - - operator: containsGeneral
          left:
            value:
              complex:
                root: alert.asmcloud
                accessor: provider
            iscontext: true
          right:
            value:
              simple: AWS
    - label: GCP
      condition:
      - - operator: containsGeneral
          left:
            value:
              complex:
                root: alert.asmcloud
                accessor: provider
            iscontext: true
          right:
            value:
              simple: GCP
    - label: Azure
      condition:
      - - operator: containsGeneral
          left:
            value:
              complex:
                root: alert.asmcloud
                accessor: provider
            iscontext: true
          right:
            value:
              simple: Azure
    - label: On Prem
      condition:
      - - operator: containsGeneral
          left:
            value:
              complex:
                root: alert.asmcloud
                accessor: provider
            iscontext: true
          right:
            value:
              simple: On Prem
    - label: Unclaimed S3 Bucket
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: alert
                accessor: asmattacksurfaceruleid
                transformers:
                - operator: StripChars
                  args:
                    chars:
                      value:
                        simple: '[\"]'
            iscontext: true
          right:
            value:
              simple: UnclaimedS3Bucket
    continueonerrortype: ''
    view: "{\n  \"position\": {\n    \"x\": 550,\n    \"y\": -45\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '17':
    id: '17'
    taskid: 5155d577-2c0b-43e0-8545-bbbfe1a0f1b7
    type: regular
    task:
      id: 5155d577-2c0b-43e0-8545-bbbfe1a0f1b7
      version: -1
      name: Set temp context
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '10'
    scriptarguments:
      key:
        simple: bucketname
      value:
        complex:
          root: alert.asmsystemids
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: alert.asmsystemids.type
                iscontext: true
              right:
                value:
                  simple: S3-BucketName
          accessor: id
    separatecontext: false
    continueonerrortype: ''
    view: "{\n  \"position\": {\n    \"x\": 1150,\n    \"y\": 190\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '20':
    id: '20'
    taskid: f35a1ba6-d5bb-4e43-8752-c2eb9c9052e7
    type: regular
    task:
      id: f35a1ba6-d5bb-4e43-8752-c2eb9c9052e7
      version: -1
      name: Set temp context
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '29'
    scriptarguments:
      key:
        simple: PortAndProtocol
      value:
        complex:
          root: alert
          accessor: remoteport
          transformers:
          - operator: Stringify
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: '-'
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: alert.protocol
                iscontext: true
          - operator: toLowerCase
    separatecontext: false
    continueonerrortype: ''
    view: "{\n  \"position\": {\n    \"x\": 350,\n    \"y\": 180\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '21':
    id: '21'
    taskid: bd54653c-f60f-4315-89c8-8c6b1d619f5a
    type: regular
    task:
      id: bd54653c-f60f-4315-89c8-8c6b1d619f5a
      version: -1
      name: Set temp context
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '9'
    scriptarguments:
      key:
        simple: PortAndProtocol
      value:
        complex:
          root: alert
          accessor: remoteport
          transformers:
          - operator: Stringify
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: '-'
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: alert.protocol
                iscontext: true
          - operator: toLowerCase
    separatecontext: false
    continueonerrortype: ''
    view: "{\n  \"position\": {\n    \"x\": -50,\n    \"y\": 170\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '23':
    id: '23'
    taskid: 22ae4de0-bc50-45d8-82af-2ef2eb042aac
    type: regular
    task:
      id: 22ae4de0-bc50-45d8-82af-2ef2eb042aac
      version: -1
      name: Set temp context
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '26'
    scriptarguments:
      key:
        simple: IPString
      value:
        complex:
          root: alert
          accessor: remoteip
          transformers:
          - operator: Stringify
    separatecontext: false
    continueonerrortype: ''
    view: "{\n  \"position\": {\n    \"x\": 1570,\n    \"y\": 340\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '26':
    id: '26'
    taskid: e44ca36c-e49a-467d-8999-d72b17d20011
    type: regular
    task:
      id: e44ca36c-e49a-467d-8999-d72b17d20011
      version: -1
      name: Set remediation objectives grid field
      description: "Automation used to more easily populate a grid field.  This is necessary when you want to assign certain values as static or if you have context paths that you will assign to different values as well.  Instead of a value you can enter `TIMESTAMP` to get the current timestamp in ISO format. For example:\n`!GridFieldSetup keys=ip,src,timestamp val1=${AWS.EC2.Instances.NetworkInterfaces.PrivateIpAddress} val2=\"AWS\" val3=\"TIMESTAMP\" gridfiled=\"gridfield\"`"
      scriptName: GridFieldSetup
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '5'
    scriptarguments:
      gridfield:
        simple: asmremediationobjectives
      keys:
        simple: option,statement
      val1:
        simple: Automated remediation by blocking open ports
      val2:
        complex:
          root: alert
          accessor: id
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: 'In this case, automated remediation will create a new firewall rule on the top of the ruleset called "xpanse-ar-rule - '
              suffix:
                value:
                  simple: '".  This rule will block internet traffic to the IP address of '
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ${IPString}
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ' for port '
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ${PortAndProtocol}
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: .
    separatecontext: false
    continueonerrortype: ''
    view: "{\n  \"position\": {\n    \"x\": 1570,\n    \"y\": 500\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '28':
    id: '28'
    taskid: f86d9640-7d89-491e-856c-f681119fc775
    type: regular
    task:
      id: f86d9640-7d89-491e-856c-f681119fc775
      version: -1
      name: Set temp context
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '23'
    scriptarguments:
      key:
        simple: PortAndProtocol
      value:
        complex:
          root: alert
          accessor: remoteport
          transformers:
          - operator: Stringify
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: '-'
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: alert.protocol
                iscontext: true
          - operator: toLowerCase
    separatecontext: false
    continueonerrortype: ''
    view: "{\n  \"position\": {\n    \"x\": 1570,\n    \"y\": 155\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '29':
    id: '29'
    taskid: e0044476-dbdf-49a4-8e60-9b65ea945cf1
    type: regular
    task:
      id: e0044476-dbdf-49a4-8e60-9b65ea945cf1
      version: -1
      name: Set VPCNetwork temporary context
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '12'
    scriptarguments:
      key:
        simple: VPCNetwork
      value:
        complex:
          root: alert.asmsystemids
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: alert.asmsystemids.type
                iscontext: true
              right:
                value:
                  simple: ASSET-VIRTUAL-NET
          accessor: id
          transformers:
          - operator: split
            args:
              delimiter:
                value:
                  simple: networks/
          - operator: LastArrayElement
          - operator: substring
            args:
              from:
                value:
                  simple: '0'
              to:
                value:
                  simple: '29'
    separatecontext: false
    continueonerrortype: ''
    view: "{\n  \"position\": {\n    \"x\": 350,\n    \"y\": 340\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '30':
    id: '30'
    taskid: e6feba9a-90a9-4dcc-837e-d7456532b19e
    type: regular
    task:
      id: e6feba9a-90a9-4dcc-837e-d7456532b19e
      version: -1
      name: Set remediation objectives grid field
      description: "Automation used to more easily populate a grid field.  This is necessary when you want to assign certain values as static or if you have context paths that you will assign to different values as well.  Instead of a value you can enter `TIMESTAMP` to get the current timestamp in ISO format. For example:\n`!GridFieldSetup keys=ip,src,timestamp val1=${AWS.EC2.Instances.NetworkInterfaces.PrivateIpAddress} val2=\"AWS\" val3=\"TIMESTAMP\" gridfiled=\"gridfield\"`"
      scriptName: GridFieldSetup
      type: regular
      iscommand: false
      brand: ''
    scriptarguments:
      gridfield:
        simple: asmremediationobjectives
      keys:
        simple: option,statement
      val1:
        simple: Automated remediation by blocking open ports
      val2:
        complex:
          root: alert.asmsystemids
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: alert.asmsystemids.type
                iscontext: true
              right:
                value:
                  simple: ASSET-NAME
          accessor: id
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: ' will ensure that internal communication to this asset can continue.  After these rules are created, '
              suffix:
                value:
                  simple: ' will have a new network tag named remediation-tag-'
          - operator: concat
            args:
              prefix:
                value:
                  simple: PortAndProtocol
                iscontext: true
              suffix:
                value:
                  simple: PortAndProtocol
                iscontext: true
          - operator: concat
            args:
              prefix:
                value:
                  simple: ' will block all internet traffic to this service and remediation-allow-port-'
              suffix:
                value:
                  simple: ' which will apply these new firewall rules and restrict public internet access.'
          - operator: concat
            args:
              prefix:
                value:
                  simple: PortAndProtocol
                iscontext: true
              suffix: {}
          - operator: concat
            args:
              prefix:
                value:
                  simple: 'In this case, automated remediation will create two new firewall rules: rule remediation-block-port-'
              suffix: {}
    separatecontext: false
    continueonerrortype: ''
    view: "{\n  \"position\": {\n    \"x\": 340,\n    \"y\": 940\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: "{\n  \"linkLabelsPosition\": {\n    \"14_4_AWS\": 0.52\n  },\n  \"paper\": {\n    \"dimensions\": {\n      \"height\": 1215,\n      \"width\": 2000,\n      \"x\": -50,\n      \"y\": -180\n    }\n  }\n}"
inputs: []
outputs: []
